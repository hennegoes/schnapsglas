<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>SchnapsglÃ¤ser aus aller Welt</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VARIABLEN & RESET
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --gold:        #C8860A;
      --gold-hell:   #E8A520;
      --bg:          #0F0A04;
      --panel:       #1A1208;
      --panel2:      #221A0A;
      --border:      rgba(200,134,10,0.22);
      --border-gold: rgba(200,134,10,0.55);
      --hell:        #F0E6CC;
      --muted:       #7A6540;
      --text:        #CDB98A;
      --green:       #4A9460;
      --red:         #944A4A;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: 'Lora', Georgia, serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 54px;
      background: linear-gradient(135deg, #0F0A04 0%, #1E1408 100%);
      border-bottom: 1px solid var(--border-gold);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 900;
      box-shadow: 0 2px 20px rgba(0,0,0,0.7);
    }

    .header-left { display: flex; align-items: center; gap: 10px; }

    .header-logo { font-size: 24px; }

    .header-titles h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(0.85rem, 3vw, 1.05rem);
      color: var(--gold-hell);
      line-height: 1.1;
    }
    .header-titles p {
      font-size: 0.58rem;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .header-right { display: flex; align-items: center; gap: 8px; }

    #zaehler {
      background: rgba(200,134,10,0.1);
      border: 1px solid var(--border-gold);
      border-radius: 20px;
      color: var(--gold-hell);
      padding: 3px 12px;
      font-size: 0.72rem;
    }

    /* Admin-Button */
    #admin-btn {
      width: 36px; height: 36px;
      background: rgba(200,134,10,0.12);
      border: 1px solid var(--border-gold);
      border-radius: 50%;
      color: var(--gold);
      font-size: 16px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    #admin-btn:hover { background: rgba(200,134,10,0.25); transform: rotate(15deg); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       KARTE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #map {
      position: fixed;
      top: 54px; left: 0; right: 0; bottom: 0;
      z-index: 1;
    }

    /* Leaflet-Kacheln leicht abdunkeln */
    .leaflet-tile { filter: brightness(0.88) saturate(0.85); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CUSTOM MARKER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .marker-pin {
      width: 40px; height: 40px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      background: var(--gold);
      border: 2px solid var(--hell);
      box-shadow: 0 3px 12px rgba(200,134,10,0.6);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      cursor: pointer;
      overflow: hidden;
    }
    .marker-pin:hover {
      transform: rotate(-45deg) scale(1.15);
      box-shadow: 0 5px 20px rgba(200,134,10,0.8);
    }
    .marker-pin .pin-inner {
      transform: rotate(45deg);
      font-size: 16px;
      margin-top: -2px; margin-left: -1px;
    }

    /* Foto-Pin: Bild fÃ¼llt den Pin, mittig zentriert */
    .marker-pin .pin-foto {
      transform: rotate(45deg);
      width: 44px; height: 44px;
      object-fit: cover;
      object-position: center;
      display: block;
      border-radius: 1px;
    }

    /* Farb-Varianten */
    .marker-pin.gekauft {
      background: #3B82F6;
      border-color: #BFDBFE;
      box-shadow: 0 3px 12px rgba(59,130,246,0.6);
    }
    .marker-pin.gekauft:hover  { box-shadow: 0 5px 20px rgba(59,130,246,0.8); }
    .marker-pin.geschenkt {
      background: #EA580C;
      border-color: #FED7AA;
      box-shadow: 0 3px 12px rgba(234,88,12,0.6);
    }
    .marker-pin.geschenkt:hover { box-shadow: 0 5px 20px rgba(234,88,12,0.8); }

    /* Foto-Pin bekommt weiÃŸen Rahmen unabhÃ¤ngig von Kategorie */
    .marker-pin.hat-foto {
      border: 2.5px solid #fff;
      box-shadow: 0 3px 14px rgba(0,0,0,0.5);
      padding: 0;
    }
    .marker-pin.hat-foto:hover {
      transform: rotate(-45deg) scale(1.15);
      box-shadow: 0 5px 22px rgba(0,0,0,0.6);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       POPUP
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .leaflet-popup-content-wrapper {
      background: var(--panel);
      border: 1px solid var(--gold);
      border-radius: 16px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 12px 48px rgba(0,0,0,0.8);
    }
    .leaflet-popup-tip { background: var(--gold); }
    .leaflet-popup-content { margin: 0 !important; width: 280px !important; }
    .leaflet-popup-close-button {
      color: var(--gold) !important;
      font-size: 20px !important;
      top: 8px !important; right: 10px !important;
      z-index: 10;
    }

    .popup-img {
      width: 100%; height: 168px;
      object-fit: cover; display: block;
    }
    .popup-no-img {
      width: 100%; height: 140px;
      background: linear-gradient(135deg, #2D1F05 0%, #5A3A10 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 52px;
    }
    .popup-body { padding: 14px 16px 18px; }
    .popup-land {
      font-size: 0.62rem; color: var(--gold);
      letter-spacing: 2.5px; text-transform: uppercase; margin-bottom: 4px;
    }
    .popup-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.05rem; color: var(--hell);
      line-height: 1.3; margin-bottom: 4px;
    }
    .popup-datum { font-size: 0.68rem; color: var(--muted); margin-bottom: 10px; }
    .popup-text {
      font-size: 0.81rem; color: #C4B090;
      line-height: 1.65; font-style: italic;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       OVERLAY (Passwort + Admin-Panel)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.82);
      backdrop-filter: blur(6px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;  /* von unten einschieben auf Mobile */
      justify-content: center;
      padding: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    .overlay.visible {
      opacity: 1;
      pointer-events: all;
    }

    /* Sheet-Container */
    .sheet {
      background: var(--panel);
      border: 1px solid var(--border-gold);
      border-bottom: none;
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-width: 520px;
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32,0.72,0,1);
      overflow: hidden;
    }
    .overlay.visible .sheet {
      transform: translateY(0);
    }

    /* Sheet Handle */
    .sheet-handle {
      width: 40px; height: 4px;
      background: var(--border-gold);
      border-radius: 2px;
      margin: 12px auto 0;
      flex-shrink: 0;
    }

    /* Sheet Header */
    .sheet-header {
      padding: 14px 20px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sheet-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      color: var(--gold-hell);
    }
    .sheet-close {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      width: 32px; height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .sheet-close:hover { color: var(--hell); border-color: var(--border-gold); }

    /* Sheet Body scrollbar */
    .sheet-body {
      flex: 1;
      overflow-y: auto;
      padding: 18px 20px;
      -webkit-overflow-scrolling: touch;
    }
    .sheet-body::-webkit-scrollbar { width: 3px; }
    .sheet-body::-webkit-scrollbar-thumb { background: var(--border-gold); border-radius: 3px; }

    /* â”€â”€ Passwort-Panel â”€â”€ */
    #pw-panel { text-align: center; padding: 24px 20px 32px; }
    #pw-panel p { font-size: 0.88rem; color: var(--muted); margin-bottom: 20px; line-height: 1.6; }

    /* â”€â”€ Formular â”€â”€ */
    .form-section {
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 10px;
      margin-top: 18px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border);
    }
    .form-section:first-child { margin-top: 0; }

    .form-group { margin-bottom: 12px; }

    label {
      display: block;
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .req { color: var(--gold); }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    input[type="date"],
    textarea,
    select {
      width: 100%;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 10px 13px;
      font-family: 'Lora', serif;
      font-size: 0.85rem;
      color: var(--hell);
      outline: none;
      transition: border-color 0.15s, background 0.15s;
      -webkit-appearance: none;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--gold);
      background: rgba(200,134,10,0.06);
    }
    input::placeholder, textarea::placeholder { color: var(--muted); opacity: 0.65; }
    textarea { resize: vertical; min-height: 80px; line-height: 1.6; }

    /* Foto-Upload */
    .foto-upload-area {
      border: 2px dashed var(--border-gold);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      background: rgba(200,134,10,0.03);
    }
    .foto-upload-area:hover { background: rgba(200,134,10,0.07); border-color: var(--gold); }
    .foto-upload-area.has-foto { padding: 0; border-style: solid; overflow: hidden; }

    #foto-input { display: none; }

    .foto-preview {
      width: 100%; height: 180px;
      object-fit: cover; display: block;
      border-radius: 10px;
    }

    .foto-placeholder { color: var(--muted); }
    .foto-placeholder .icon { font-size: 32px; margin-bottom: 8px; display: block; }
    .foto-placeholder p { font-size: 0.8rem; line-height: 1.5; }
    .foto-placeholder span { font-size: 0.68rem; color: var(--muted); opacity: 0.6; display: block; margin-top: 4px; }

    .foto-change {
      position: absolute;
      bottom: 8px; right: 8px;
      background: rgba(0,0,0,0.7);
      border: 1px solid var(--border-gold);
      border-radius: 6px;
      color: var(--gold);
      font-size: 0.7rem;
      padding: 4px 10px;
      cursor: pointer;
    }

    /* Koordinaten */
    .coord-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .coord-hint {
      font-size: 0.68rem; color: var(--muted);
      margin-top: 6px; line-height: 1.5;
    }
    .coord-hint a { color: var(--gold); text-decoration: none; }
    .coord-hint a:hover { text-decoration: underline; }

    /* â”€â”€ Feedback â”€â”€ */
    .feedback-msg {
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.78rem;
      margin-bottom: 10px;
      display: none;
      line-height: 1.4;
    }
    .feedback-msg.ok  { display: block; background: rgba(74,148,96,0.12);  border: 1px solid rgba(74,148,96,0.4);  color: #8FD4A8; }
    .feedback-msg.err { display: block; background: rgba(148,74,74,0.12);  border: 1px solid rgba(148,74,74,0.4);  color: #D4A08F; }

    /* Cloudinary-Fortschritt */
    .upload-progress {
      display: none;
      align-items: center;
      gap: 10px;
      font-size: 0.78rem;
      color: var(--gold);
      margin-bottom: 10px;
    }
    .upload-progress.active { display: flex; }
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Sheet Footer â”€â”€ */
    .sheet-footer {
      padding: 14px 20px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      gap: 8px;
    }

    .btn-primary {
      flex: 1;
      background: var(--gold);
      color: var(--bg);
      border: none;
      border-radius: 10px;
      padding: 13px;
      font-family: 'Lora', serif;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary:hover { background: var(--gold-hell); }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 10px;
      padding: 13px 16px;
      font-family: 'Lora', serif;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-secondary:hover { border-color: var(--border-gold); color: var(--text); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EXPORT BUTTON (floating, unten links)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #export-btn {
      position: fixed;
      bottom: 24px;
      right: 16px;
      z-index: 800;
      background: var(--panel);
      border: 1px solid var(--border-gold);
      border-radius: 12px;
      color: var(--gold);
      padding: 10px 16px;
      font-family: 'Lora', serif;
      font-size: 0.76rem;
      cursor: pointer;
      display: none;       /* nur sichtbar wenn eingeloggt */
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      transition: all 0.2s;
    }
    #export-btn:hover { background: rgba(200,134,10,0.12); transform: translateY(-2px); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE FAB (Floating Action Button)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #fab {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 800;
      background: var(--gold);
      color: var(--bg);
      border: none;
      border-radius: 28px;
      padding: 14px 28px;
      font-family: 'Playfair Display', serif;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 6px 28px rgba(200,134,10,0.55);
      display: none;   /* nur nach Login sichtbar */
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    #fab:hover { background: var(--gold-hell); transform: translateX(-50%) translateY(-2px); }
    #fab:active { transform: translateX(-50%) scale(0.97); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CODE-ANZEIGE (nach Export)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .code-box {
      background: #080604;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      font-family: 'Courier New', monospace;
      font-size: 0.72rem;
      color: #C8B890;
      max-height: 220px;
      overflow-y: auto;
      white-space: pre;
      line-height: 1.7;
      margin-top: 12px;
    }

    .copy-btn {
      width: 100%;
      background: transparent;
      border: 1px solid var(--border-gold);
      border-radius: 8px;
      color: var(--gold);
      padding: 8px;
      font-family: 'Lora', serif;
      font-size: 0.78rem;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.15s;
    }
    .copy-btn:hover { background: rgba(200,134,10,0.08); }
    .copy-btn.copied { color: var(--green); border-color: var(--green); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GLÃ„SER-LISTE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .glaeser-liste {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .glaeser-liste-leer {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 0.88rem;
      font-style: italic;
    }
    .glaeser-liste-leer span { display: block; font-size: 2.5rem; margin-bottom: 10px; opacity: 0.3; }

    .glas-karte {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.15s;
    }
    .glas-karte:hover { border-color: var(--border-gold); }

    .glas-karte-top {
      display: flex;
      gap: 12px;
      padding: 12px;
      align-items: center;
    }

    .glas-karte-foto {
      width: 52px; height: 52px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      background: linear-gradient(135deg, #2D1F05, #5A3A10);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
    }
    .glas-karte-foto img {
      width: 100%; height: 100%;
      object-fit: cover; border-radius: 8px;
    }

    .glas-karte-info { flex: 1; min-width: 0; }
    .glas-karte-name {
      font-size: 0.88rem; color: var(--hell); font-weight: 500;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .glas-karte-land {
      font-size: 0.63rem; color: var(--gold);
      letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px;
    }
    .glas-karte-datum {
      font-size: 0.68rem; color: var(--muted); margin-top: 3px;
    }

    .glas-karte-aktionen {
      display: flex;
      border-top: 1px solid var(--border);
    }

    .glas-aktion-btn {
      flex: 1;
      background: transparent;
      border: none;
      padding: 9px 8px;
      font-family: 'Lora', serif;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .glas-aktion-btn.bearbeiten {
      color: var(--gold);
      border-right: 1px solid var(--border);
    }
    .glas-aktion-btn.bearbeiten:hover { background: rgba(200,134,10,0.08); }
    .glas-aktion-btn.loeschen { color: var(--red); }
    .glas-aktion-btn.loeschen:hover { background: rgba(148,74,74,0.08); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       KATEGORIE-BADGE im Popup & Liste
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .popup-kategorie {
      display: inline-flex; align-items: center; gap: 5px;
      border-radius: 20px; padding: 3px 10px;
      font-size: 0.62rem; font-weight: 600;
      letter-spacing: 1px; text-transform: uppercase;
      margin-bottom: 8px;
    }
    .popup-kategorie.gekauft  { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.4); color: #7EB8F7; }
    .popup-kategorie.geschenkt{ background: rgba(234,88,12,0.15);  border: 1px solid rgba(234,88,12,0.4);  color: #FDBA74; }

    .glas-karte-kategorie {
      display: inline-flex; align-items: center; gap: 4px;
      border-radius: 12px; padding: 2px 8px;
      font-size: 0.62rem; font-weight: 600;
      letter-spacing: 0.5px; margin-top: 3px;
    }
    .glas-karte-kategorie.gekauft  { background: rgba(59,130,246,0.12); color: #7EB8F7; }
    .glas-karte-kategorie.geschenkt{ background: rgba(234,88,12,0.12);  color: #FDBA74; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MARKER FARBEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .marker-pin.gekauft {
      background: #3B82F6;
      box-shadow: 0 3px 12px rgba(59,130,246,0.6);
    }
    .marker-pin.gekauft:hover {
      background: #60A5FA;
      box-shadow: 0 5px 20px rgba(59,130,246,0.8);
    }
    .marker-pin.geschenkt {
      background: #EA580C;
      box-shadow: 0 3px 12px rgba(234,88,12,0.6);
    }
    .marker-pin.geschenkt:hover {
      background: #FB923C;
      box-shadow: 0 5px 20px rgba(234,88,12,0.8);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FILTER-PANEL (von rechts einschieben)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #filter-panel {
      position: fixed;
      top: 54px; right: 0; bottom: 0;
      width: 300px;
      background: var(--panel);
      border-left: 1px solid var(--border-gold);
      z-index: 700;
      display: flex; flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
      box-shadow: -4px 0 32px rgba(0,0,0,0.5);
    }
    #filter-panel.offen { transform: translateX(0); }

    .filter-header {
      padding: 16px 18px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .filter-header-title {
      font-family: 'Playfair Display', serif;
      font-size: 1rem; color: var(--gold-hell);
    }
    .filter-close {
      background: transparent; border: 1px solid var(--border);
      color: var(--muted); width: 28px; height: 28px;
      border-radius: 50%; cursor: pointer; font-size: 14px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .filter-close:hover { color: var(--hell); border-color: var(--border-gold); }

    .filter-body {
      flex: 1; overflow-y: auto; padding: 16px 18px;
    }
    .filter-body::-webkit-scrollbar { width: 3px; }
    .filter-body::-webkit-scrollbar-thumb { background: var(--border-gold); border-radius: 3px; }

    .filter-section {
      font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase;
      color: var(--gold); margin-bottom: 10px; margin-top: 18px;
      padding-bottom: 5px; border-bottom: 1px solid var(--border);
    }
    .filter-section:first-child { margin-top: 0; }

    /* Toggle-Chips fÃ¼r Kategorie */
    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-chip {
      border-radius: 20px; padding: 6px 14px;
      font-size: 0.78rem; cursor: pointer;
      border: 1px solid var(--border); background: transparent;
      color: var(--muted); font-family: 'Lora', serif;
      transition: all 0.15s;
    }
    .filter-chip:hover { border-color: var(--border-gold); color: var(--text); }
    .filter-chip.aktiv.gekauft  { background: rgba(59,130,246,0.2); border-color: #3B82F6; color: #7EB8F7; }
    .filter-chip.aktiv.geschenkt{ background: rgba(234,88,12,0.2);  border-color: #EA580C; color: #FDBA74; }
    .filter-chip.aktiv.alle     { background: rgba(200,134,10,0.2); border-color: var(--gold); color: var(--gold-hell); }

    /* LÃ¤nder-Checkboxen */
    .filter-land-item {
      display: flex; align-items: center; gap: 10px;
      padding: 6px 0; font-size: 0.82rem; cursor: pointer;
      border-bottom: 1px solid rgba(200,134,10,0.08);
    }
    .filter-land-item:last-child { border-bottom: none; }
    .filter-land-item input[type="checkbox"] {
      width: 16px; height: 16px; flex-shrink: 0;
      accent-color: var(--gold); cursor: pointer;
    }
    .filter-land-item label { color: var(--text); cursor: pointer; margin: 0; font-size: 0.82rem; }
    .filter-land-anzahl { margin-left: auto; font-size: 0.68rem; color: var(--muted); }

    /* Jahr-Checkboxen */
    .filter-jahr-item {
      display: flex; align-items: center; gap: 10px;
      padding: 5px 0; font-size: 0.82rem; cursor: pointer;
    }
    .filter-jahr-item input[type="checkbox"] {
      width: 16px; height: 16px; flex-shrink: 0;
      accent-color: var(--gold); cursor: pointer;
    }
    .filter-jahr-item label { color: var(--text); cursor: pointer; margin: 0; font-size: 0.82rem; }

    .filter-footer {
      padding: 12px 18px;
      border-top: 1px solid var(--border);
      display: flex; gap: 8px; flex-shrink: 0;
    }
    .filter-reset {
      flex: 1; background: transparent; border: 1px solid var(--border);
      color: var(--muted); border-radius: 8px; padding: 9px;
      font-family: 'Lora', serif; font-size: 0.8rem; cursor: pointer;
      transition: all 0.15s;
    }
    .filter-reset:hover { border-color: var(--border-gold); color: var(--text); }
    .filter-anwenden {
      flex: 1; background: var(--gold); border: none;
      color: var(--bg); border-radius: 8px; padding: 9px;
      font-family: 'Lora', serif; font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
    }
    .filter-anwenden:hover { background: var(--gold-hell); }

    /* Filter-Button (floating) */
    #filter-btn {
      position: fixed;
      top: 64px; right: 12px;
      z-index: 699;
      background: var(--panel);
      border: 1px solid var(--border-gold);
      border-radius: 10px;
      color: var(--gold);
      padding: 8px 14px;
      font-family: 'Lora', serif;
      font-size: 0.78rem;
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
      transition: all 0.2s;
    }
    #filter-btn:hover { background: rgba(200,134,10,0.12); }
    #filter-btn.aktiv { background: rgba(200,134,10,0.2); border-color: var(--gold); }
    .filter-badge {
      background: var(--gold); color: var(--bg);
      border-radius: 50%; width: 16px; height: 16px;
      font-size: 0.6rem; font-weight: 700;
      display: none; align-items: center; justify-content: center;
    }
    .filter-badge.sichtbar { display: flex; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FOTO-URL EINGABE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .foto-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .foto-tab {
      flex: 1;
      background: transparent;
      border: none;
      padding: 9px 8px;
      font-family: 'Lora', serif;
      font-size: 0.78rem;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
      border-right: 1px solid var(--border);
    }
    .foto-tab:last-child { border-right: none; }
    .foto-tab.aktiv { background: rgba(200,134,10,0.1); color: var(--gold-hell); }
    .foto-tab:hover:not(.aktiv) { background: rgba(255,255,255,0.03); }

    .foto-url-bereich { display: none; }
    .foto-url-bereich.aktiv { display: block; }
    .foto-upload-bereich { display: none; }
    .foto-upload-bereich.aktiv { display: block; }

    .foto-url-vorschau {
      width: 100%; height: 140px;
      object-fit: cover;
      border-radius: 10px;
      margin-top: 8px;
      display: none;
      border: 1px solid var(--border);
    }
    .foto-url-vorschau.sichtbar { display: block; }
    .foto-url-fehler {
      font-size: 0.72rem; color: #D4A08F;
      margin-top: 5px; display: none;
    }
    .foto-url-fehler.sichtbar { display: block; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       POPUP NAVIGATION (mehrere GlÃ¤ser)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .popup-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,0.2);
    }
    .popup-nav-btn {
      background: rgba(200,134,10,0.12);
      border: 1px solid var(--border-gold);
      border-radius: 8px;
      color: var(--gold);
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .popup-nav-btn:hover { background: rgba(200,134,10,0.25); }
    .popup-nav-btn:disabled { opacity: 0.25; cursor: default; }
    .popup-nav-info {
      font-size: 0.7rem;
      color: var(--muted);
      text-align: center;
      line-height: 1.4;
    }
    .popup-nav-info strong { color: var(--gold); font-size: 0.75rem; }
  </style>
</head>
<body>

<!-- â•â• HEADER â•â• -->
<header>
  <div class="header-left">
    <div class="header-logo">ğŸ¥ƒ</div>
    <div class="header-titles">
      <h1>SchnapsglÃ¤ser aus aller Welt</h1>
      <p>Meine persÃ¶nliche Sammlung</p>
    </div>
  </div>
  <div class="header-right">
    <span id="zaehler">0 GlÃ¤ser</span>
    <button id="admin-btn" onclick="adminOeffnen()" title="Glas hinzufÃ¼gen / Admin">âš™</button>
  </div>
</header>

<!-- â•â• KARTE â•â• -->
<div id="map"></div>

<!-- â•â• FAB (nach Login) â•â• -->
<button id="fab" onclick="formularOeffnen()">
  <span>ï¼‹</span> Glas hinzufÃ¼gen
</button>

<!-- â•â• LISTE BUTTON (nach Login) â•â• -->
<button id="liste-btn" onclick="listeOeffnen()" style="
  position:fixed; bottom:24px; left:16px; z-index:800;
  background:var(--panel); border:1px solid var(--border-gold);
  border-radius:28px; padding:14px 22px;
  font-family:'Lora',serif; font-size:0.88rem;
  color:var(--gold); cursor:pointer;
  box-shadow:0 6px 28px rgba(0,0,0,0.5);
  display:none; align-items:center; gap:8px;
  transition:all 0.2s; white-space:nowrap;
">ğŸ“‹ Meine GlÃ¤ser</button>

<!-- â•â• FILTER BUTTON â•â• -->
<button id="filter-btn" onclick="filterToggle()">
  ğŸ” Filter
  <span class="filter-badge" id="filter-badge"></span>
</button>

<!-- â•â• FILTER PANEL â•â• -->
<div id="filter-panel">
  <div class="filter-header">
    <div class="filter-header-title">ğŸ” Filter</div>
    <button class="filter-close" onclick="filterToggle()">âœ•</button>
  </div>
  <div class="filter-body" id="filter-body">
    <!-- wird dynamisch befÃ¼llt -->
  </div>
  <div class="filter-footer">
    <button class="filter-reset" onclick="filterZuruecksetzen()">â†º ZurÃ¼cksetzen</button>
    <button class="filter-anwenden" onclick="filterAnwenden()">âœ“ Anwenden</button>
  </div>
</div>

<!-- â•â• EXPORT BUTTON (nach Login) â•â• -->
<button id="export-btn" onclick="exportPanel()">
  â¬‡ data.js exportieren
</button>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     OVERLAY: Alles lÃ¤uft durch diesen Container
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="overlay" onclick="overlayKlick(event)">
  <div class="sheet" id="sheet">
    <div class="sheet-handle"></div>

    <!-- SHEET HEADER -->
    <div class="sheet-header">
      <div class="sheet-title" id="sheet-title">Admin-Bereich</div>
      <button class="sheet-close" onclick="overlaySchliessen()">âœ•</button>
    </div>

    <!-- SHEET BODY â€“ wird dynamisch befÃ¼llt -->
    <div class="sheet-body" id="sheet-body"></div>

    <!-- SHEET FOOTER â€“ wird dynamisch befÃ¼llt -->
    <div class="sheet-footer" id="sheet-footer"></div>
  </div>
</div>


<!-- â•â• DATEN â•â• -->
<script src="data.js"></script>

<!-- â•â• LEAFLET â•â• -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KONFIGURATION
   â†“ Hier deine eigenen Werte eintragen â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CONFIG = {
  // Passwort fÃ¼r den Admin-Bereich
  passwort: "Flugzeug",

  // Cloudinary â€“ nach Registrierung ausfÃ¼llen:
  cloudinary_cloud_name: "dpp3xfy5q",   // z.B. "abc123xyz"
  cloudinary_upload_preset: "schnapsglas",     // Upload Preset Name
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZUSTAND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let eingeloggt   = false;
let aktuellesFoto = null;   // { blob, dataUrl } â€“ vom Handy gewÃ¤hlt
let naechsteId   = Math.max(0, ...GLAESER.map(g => g.id)) + 1;
let markerMap    = {};      // id â†’ Leaflet-Marker (fÃ¼r spÃ¤teres Entfernen)

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KARTE INITIALISIEREN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const map = L.map("map", {
  center: [30, 15], zoom: 3,
  zoomControl: false, attributionControl: false
});

L.control.zoom({ position: "bottomright" }).addTo(map);
L.control.attribution({
  position: "bottomleft",
  prefix: "Â© <a href='https://carto.com' target='_blank'>CartoDB</a>"
}).addTo(map);

L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  maxZoom: 19
}).addTo(map);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARKER ICON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function markerIcon(kategorie, foto) {
  const cls = kategorie === "gekauft" ? "gekauft" : kategorie === "geschenkt" ? "geschenkt" : "";

  if (foto) {
    // Foto-Pin: Bild fÃ¼llt den Pin, rotiert damit es aufrecht steht
    return L.divIcon({
      className: "",
      html: `<div class="marker-pin hat-foto ${cls}">
               <img class="pin-foto" src="${foto}" alt="">
             </div>`,
      iconSize:    [40, 40],
      iconAnchor:  [20, 40],
      popupAnchor: [0, -44]
    });
  }

  return L.divIcon({
    className: "",
    html: `<div class="marker-pin ${cls}"><div class="pin-inner">ğŸ¥ƒ</div></div>`,
    iconSize:    [40, 40],
    iconAnchor:  [20, 40],
    popupAnchor: [0, -44]
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function popupHTML(g) {
  const img = g.foto
    ? `<img class="popup-img" src="${g.foto}" alt="${esc(g.name)}">`
    : `<div class="popup-no-img">ğŸ¥ƒ</div>`;

  const datum = g.datum
    ? `<div class="popup-datum">ğŸ“… ${formatDatum(g.datum)}</div>`
    : "";

  const kat = g.kategorie === "gekauft"
    ? `<div class="popup-kategorie gekauft">âœˆ Selbst gekauft</div>`
    : g.kategorie === "geschenkt"
    ? `<div class="popup-kategorie geschenkt">ğŸ Geschenkt bekommen</div>`
    : "";

  return `<div>
    ${img}
    <div class="popup-body">
      <div class="popup-land">${esc(g.land)}</div>
      <div class="popup-name">${esc(g.name)}</div>
      ${kat}
      ${datum}
      <div class="popup-text">${esc(g.text)}</div>
    </div>
  </div>`;
}

function formatDatum(iso) {
  if (!iso) return "";
  const [y, m, d] = iso.split("-");
  return `${d}.${m}.${y}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALLE GLÃ„SER AUF KARTE SETZEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function alleGlaeserLaden() {
  // GlÃ¤ser nach Koordinaten gruppieren (gleiche lat+lng = gleicher Ort)
  const gruppen = {};
  GLAESER.forEach(g => {
    const key = `${g.lat},${g.lng}`;
    if (!gruppen[key]) gruppen[key] = [];
    gruppen[key].push(g);
  });

  // Pro Gruppe einen Marker setzen
  Object.values(gruppen).forEach(gruppe => {
    const erstesGlas  = gruppe[0];
    const kat  = gruppe.length === 1 ? erstesGlas.kategorie : null;
    const foto = erstesGlas.foto || null;
    const m = L.marker([erstesGlas.lat, erstesGlas.lng], { icon: markerIcon(kat, foto) })
      .addTo(map)
      .bindPopup(gruppenPopupHTML(gruppe, 0), { maxWidth: 300, minWidth: 300 });

    // Alle IDs dieser Gruppe auf denselben Marker zeigen
    gruppe.forEach(g => { markerMap[g.id] = m; });
  });

  const n = GLAESER.length;
  document.getElementById("zaehler").textContent =
    n + (n === 1 ? " Glas" : " GlÃ¤ser");
}

/* â”€â”€ Popup-HTML fÃ¼r eine Gruppe (mit Navigation) â”€â”€ */
function gruppenPopupHTML(gruppe, index) {
  const g = gruppe[index];
  const gesamt = gruppe.length;

  const nav = gesamt > 1 ? `
    <div class="popup-nav">
      <button class="popup-nav-btn"
        ${index === 0 ? "disabled" : ""}
        onclick="popupNavigation(this, ${JSON.stringify(gruppe.map(x=>x.id)).replace(/"/g,"'")}, ${index - 1})">â—€</button>
      <div class="popup-nav-info">
        <strong>${index + 1} / ${gesamt}</strong><br>
        ${gesamt} GlÃ¤ser an diesem Ort
      </div>
      <button class="popup-nav-btn"
        ${index === gesamt - 1 ? "disabled" : ""}
        onclick="popupNavigation(this, ${JSON.stringify(gruppe.map(x=>x.id)).replace(/"/g,"'")}, ${index + 1})">â–¶</button>
    </div>` : "";

  return `<div>${popupHTML(g)}${nav}</div>`;
}

/* â”€â”€ Navigation im Popup weiterschalten â”€â”€ */
function popupNavigation(btn, idsJson, neuerIndex) {
  // IDs aus dem onclick-Attribut parsen
  const ids   = JSON.parse(idsJson.replace(/'/g, '"'));
  const gruppe = ids.map(id => GLAESER.find(g => g.id === id)).filter(Boolean);
  if (!gruppe.length) return;

  // Marker dieses Glases finden und Popup aktualisieren
  const m = markerMap[gruppe[0].id];
  if (!m) return;
  m.setPopupContent(gruppenPopupHTML(gruppe, neuerIndex));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY Ã–FFNEN / SCHLIESSEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function overlayOeffnen() {
  document.getElementById("overlay").classList.add("visible");
  document.body.style.overflow = "hidden";
}

function overlaySchliessen() {
  document.getElementById("overlay").classList.remove("visible");
  document.body.style.overflow = "";
  aktuellesFoto = null;
}

function overlayKlick(e) {
  if (e.target === document.getElementById("overlay")) overlaySchliessen();
}

function setSheet(title, body, footer) {
  document.getElementById("sheet-title").textContent  = title;
  document.getElementById("sheet-body").innerHTML     = body;
  document.getElementById("sheet-footer").innerHTML   = footer;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN-BUTTON: Passwort oder direkt Formular
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function adminOeffnen() {
  if (eingeloggt) {
    formularOeffnen();
  } else {
    passwortPanel();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PASSWORT-PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function passwortPanel() {
  setSheet(
    "ğŸ” Admin-Zugang",
    `<div id="pw-panel">
      <p>Gib dein Passwort ein um GlÃ¤ser hinzuzufÃ¼gen.</p>
      <div class="form-group">
        <input type="password" id="pw-input"
          placeholder="Passwort"
          onkeydown="if(event.key==='Enter') passwortPruefen()">
      </div>
      <div class="feedback-msg" id="pw-feedback"></div>
    </div>`,
    `<button class="btn-primary" onclick="passwortPruefen()">Einloggen</button>`
  );
  overlayOeffnen();
  setTimeout(() => document.getElementById("pw-input")?.focus(), 400);
}

function passwortPruefen() {
  const eingabe = document.getElementById("pw-input")?.value || "";
  if (eingabe === CONFIG.passwort) {
    eingeloggt = true;
    overlaySchliessen();
    // FAB, Liste-Button und Export-Button einblenden
    document.getElementById("fab").style.display        = "flex";
    document.getElementById("liste-btn").style.display  = "flex";
    document.getElementById("export-btn").style.display = "flex";
    setTimeout(() => formularOeffnen(), 300);
  } else {
    const fb = document.getElementById("pw-feedback");
    fb.textContent = "Falsches Passwort. Bitte erneut versuchen.";
    fb.className   = "feedback-msg err";
    document.getElementById("pw-input").value = "";
    document.getElementById("pw-input").focus();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMULAR: Neues Glas hinzufÃ¼gen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function formularOeffnen() {
  aktuellesFoto = null;

  const heute = new Date().toISOString().slice(0, 10);

  const body = `
    <div class="feedback-msg" id="form-feedback"></div>
    <div class="upload-progress" id="upload-progress">
      <div class="spinner"></div>
      <span>Foto wird hochgeladenâ€¦</span>
    </div>

    <div class="form-section">ğŸ“¸ Foto</div>

    <div class="form-group">
      <div class="foto-tabs">
        <button class="foto-tab aktiv" onclick="fotoTabWechseln('upload', this)">ğŸ“· Kamera / Galerie</button>
        <button class="foto-tab"       onclick="fotoTabWechseln('url', this)">ğŸŒ Link aus Internet</button>
      </div>

      <!-- Tab 1: Datei-Upload -->
      <div class="foto-upload-bereich aktiv" id="foto-upload-bereich">
        <div class="foto-upload-area" id="foto-area" onclick="document.getElementById('foto-input').click()">
          <div class="foto-placeholder" id="foto-placeholder">
            <span class="icon">ğŸ“·</span>
            <p>Foto aufnehmen oder aus Galerie wÃ¤hlen</p>
            <span>JPG, PNG â€“ max. 10 MB</span>
          </div>
          <img class="foto-preview" id="foto-preview" style="display:none">
          <span class="foto-change" id="foto-change" style="display:none">Foto Ã¤ndern</span>
        </div>
        <input type="file" id="foto-input" accept="image/*" capture="environment"
               onchange="fotoGewaehlt(this)">
      </div>

      <!-- Tab 2: URL -->
      <div class="foto-url-bereich" id="foto-url-bereich">
        <input type="url" id="f-foto-url" placeholder="https://upload.wikimedia.org/..."
               oninput="fotoUrlVorschau(this.value)">
        <div class="coord-hint" style="margin-top:5px">
          ğŸ’¡ Wikipedia: Bild Ã¶ffnen â†’ Rechtsklick â†’ "Bildadresse kopieren"
        </div>
        <img class="foto-url-vorschau" id="foto-url-vorschau" alt="Vorschau">
        <div class="foto-url-fehler" id="foto-url-fehler">âš  Bild konnte nicht geladen werden. URL prÃ¼fen.</div>
      </div>
    </div>

    <div class="form-section">ğŸ· Kategorie</div>

    <div class="form-group">
      <label>Wie hast du das Glas bekommen? <span class="req">*</span></label>
      <select id="f-kategorie">
        <option value="">â€“ bitte auswÃ¤hlen â€“</option>
        <option value="gekauft">âœˆ Selbst auf Reisen gekauft</option>
        <option value="geschenkt">ğŸ Geschenkt bekommen</option>
      </select>
    </div>

    <div class="form-section">ğŸ“ Ort</div>

    <div class="form-group">
      <label>Ort &amp; Name <span class="req">*</span></label>
      <input type="text" id="f-name" placeholder="z.B. Berlin, Deutschland">
    </div>

    <div class="form-group">
      <label>Land (kurz) <span class="req">*</span></label>
      <input type="text" id="f-land" placeholder="z.B. Deutschland">
    </div>

    <div class="form-group">
      <label>Koordinaten <span class="req">*</span></label>
      <div class="coord-row">
        <input type="number" id="f-lat" placeholder="Breitengrad" step="any">
        <input type="number" id="f-lng" placeholder="LÃ¤ngengrad"  step="any">
      </div>
      <div class="coord-hint">
        ğŸ—º <a href="https://maps.google.com" target="_blank">Google Maps</a>
        â†’ Ort antippen â†’ Koordinaten ablesen
      </div>
    </div>

    <div class="form-group">
      <label>Datum des Kaufs</label>
      <input type="date" id="f-datum" value="${heute}">
    </div>

    <div class="form-section">ğŸ¥ƒ Geschichte</div>

    <div class="form-group">
      <label>Deine persÃ¶nliche Geschichte <span class="req">*</span></label>
      <textarea id="f-text"
        placeholder="Wo hast du das Glas gefunden? Was ist die besondere Erinnerung dazu?"></textarea>
    </div>
  `;

  const footer = `
    <button class="btn-secondary" onclick="overlaySchliessen()">Abbrechen</button>
    <button class="btn-primary" id="submit-btn" onclick="glasHinzufuegen()">ğŸ“ Pinnen & Speichern</button>
  `;

  setSheet("ï¼‹ Neues Glas", body, footer);
  overlayOeffnen();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOTO AUSWÃ„HLEN (Handy Kamera / Galerie)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fotoGewaehlt(input) {
  const datei = input.files[0];
  if (!datei) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    aktuellesFoto = { blob: datei, dataUrl: e.target.result };

    // Vorschau zeigen
    const preview = document.getElementById("foto-preview");
    const placeholder = document.getElementById("foto-placeholder");
    const area = document.getElementById("foto-area");
    const change = document.getElementById("foto-change");

    preview.src = e.target.result;
    preview.style.display = "block";
    placeholder.style.display = "none";
    change.style.display = "block";
    area.classList.add("has-foto");
  };
  reader.readAsDataURL(datei);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLAS HINZUFÃœGEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function glasHinzufuegen() {
  const name      = document.getElementById("f-name")?.value.trim()      || "";
  const land      = document.getElementById("f-land")?.value.trim()      || "";
  const lat       = parseFloat(document.getElementById("f-lat")?.value   || "");
  const lng       = parseFloat(document.getElementById("f-lng")?.value   || "");
  const datum     = document.getElementById("f-datum")?.value            || "";
  const text      = document.getElementById("f-text")?.value.trim()      || "";
  const kategorie = document.getElementById("f-kategorie")?.value        || "";

  // Validierung
  if (!name || !land || !text) {
    zeigeFeedback("form-feedback", "Bitte Ort, Land und Geschichte ausfÃ¼llen.", "err"); return;
  }
  if (!kategorie) {
    zeigeFeedback("form-feedback", "Bitte eine Kategorie auswÃ¤hlen (gekauft oder geschenkt).", "err"); return;
  }
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
    zeigeFeedback("form-feedback", "UngÃ¼ltige Koordinaten. Breitengrad: âˆ’90 bis 90, LÃ¤ngengrad: âˆ’180 bis 180.", "err"); return;
  }

  // Button deaktivieren
  const btn = document.getElementById("submit-btn");
  btn.disabled = true;

  // Foto hochladen falls vorhanden, sonst URL nutzen
  let fotoUrl  = null;
  let fotoIsUrl = false;
  const fotoUrlEingabe = document.getElementById("f-foto-url")?.value.trim() || "";

  if (aktuellesFoto) {
    // Cloudinary noch nicht konfiguriert?
    if (CONFIG.cloudinary_cloud_name === "DEIN_CLOUD_NAME") {
      zeigeFeedback("form-feedback",
        "âš  Cloudinary noch nicht eingerichtet. Schau in die Anleitung (setup.html). Das Glas wird ohne Foto gespeichert.",
        "err");
      fotoUrl = null;
    } else {
      document.getElementById("upload-progress").classList.add("active");
      fotoUrl = await fotoHochladen(aktuellesFoto.blob);
      document.getElementById("upload-progress").classList.remove("active");

      if (!fotoUrl) {
        zeigeFeedback("form-feedback", "Foto-Upload fehlgeschlagen. Glas wird ohne Foto gespeichert.", "err");
      }
    }
  } else if (fotoUrlEingabe) {
    fotoUrl   = fotoUrlEingabe;
    fotoIsUrl = true;
  }

  // Neues Glas-Objekt
  const glas = {
    id: naechsteId++,
    name, land, lat, lng,
    foto:    fotoUrl,
    fotoUrl: fotoIsUrl ? fotoUrl : null,
    text, datum, kategorie
  };

  // Zu GLAESER-Array hinzufÃ¼gen
  GLAESER.push(glas);

  // Marker setzen â€“ falls schon GlÃ¤ser an gleichen Koordinaten existieren, Gruppe aktualisieren
  markerAktualisieren(lat, lng);

  // Karte hinfliegen
  map.flyTo([lat, lng], Math.max(map.getZoom(), 6), { duration: 1.2 });

  // ZÃ¤hler aktualisieren
  const n = GLAESER.length;
  document.getElementById("zaehler").textContent = n + (n === 1 ? " Glas" : " GlÃ¤ser");

  // Overlay schlieÃŸen & Export-Hinweis
  overlaySchliessen();
  setTimeout(() => exportHinweis(glas.name), 500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOTO ZU CLOUDINARY HOCHLADEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fotoHochladen(blob) {
  try {
    const formData = new FormData();
    formData.append("file", blob);
    formData.append("upload_preset", CONFIG.cloudinary_upload_preset);

    const res = await fetch(
      `https://api.cloudinary.com/v1_1/${CONFIG.cloudinary_cloud_name}/image/upload`,
      { method: "POST", body: formData }
    );

    if (!res.ok) return null;
    const data = await res.json();
    return data.secure_url || null;
  } catch(e) {
    console.error("Upload-Fehler:", e);
    return null;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT-HINWEIS: Nach dem HinzufÃ¼gen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportHinweis(name) {
  setSheet(
    "âœ“ Gespeichert!",
    `<div style="text-align:center; padding: 8px 0 16px;">
      <div style="font-size:3rem; margin-bottom:12px;">ğŸ¥ƒ</div>
      <p style="color:var(--hell); font-size:0.95rem; margin-bottom:8px;">
        <strong>${esc(name)}</strong> wurde zur Karte hinzugefÃ¼gt!
      </p>
      <p style="color:var(--muted); font-size:0.82rem; line-height:1.65; margin-bottom:20px;">
        Um das Glas dauerhaft zu speichern, exportiere jetzt die
        <code style="color:var(--gold)">data.js</code> und lade sie
        auf GitHub hoch.
      </p>
    </div>
    <div class="form-section">ğŸ’¾ Deine neue data.js</div>
    <p style="color:var(--muted); font-size:0.79rem; line-height:1.6; margin-bottom:12px;">
      Lade die Datei herunter und ersetze damit die <code style="color:var(--gold)">data.js</code>
      in deinem GitHub-Repository (Datei anklicken â†’ âœ Bearbeiten â†’ alles ersetzen â†’ Commit).
    </p>
    `,
    `<button class="btn-secondary" onclick="overlaySchliessen()">SchlieÃŸen</button>
     <button class="btn-primary" onclick="formularOeffnen()">ï¼‹ NÃ¤chstes Glas</button>
     <button class="btn-primary" style="background:var(--green,#4A9460)" onclick="dataJsHerunterladen()">â¬‡ data.js herunterladen</button>`
  );
  overlayOeffnen();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT PANEL (manuell Ã¼ber Button)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportPanel() {
  if (!eingeloggt) { adminOeffnen(); return; }

  setSheet(
    "â¬‡ data.js exportieren",
    `<p style="color:var(--muted); font-size:0.83rem; line-height:1.65; margin-bottom:16px;">
      Kopiere diesen Code, ersetze damit den Inhalt deiner
      <code style="color:var(--gold)">data.js</code> auf GitHub,
      und committe die Ã„nderung. Deine Karte wird automatisch aktualisiert.
    </p>
    <div class="form-section">ğŸ’¾ data.js Inhalt</div>
    <p style="color:var(--muted); font-size:0.79rem; line-height:1.6; margin-bottom:12px;">
      Datei herunterladen â†’ in deinem GitHub-Repository <code style="color:var(--gold)">data.js</code>
      anklicken â†’ âœ Bearbeiten â†’ alles ersetzen â†’ Commit.
    </p>`,
    `<button class="btn-secondary" onclick="overlaySchliessen()">SchlieÃŸen</button>
     <button class="btn-primary" style="background:var(--green,#4A9460)" onclick="dataJsHerunterladen()">â¬‡ data.js herunterladen</button>`
  );
  overlayOeffnen();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA.JS GENERIEREN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generiereDataJs() {
  const eintraege = GLAESER.map(g => {
    return [
      `  {`,
      `    id:        ${g.id},`,
      `    name:      ${JSON.stringify(g.name)},`,
      `    land:      ${JSON.stringify(g.land)},`,
      `    lat:       ${g.lat},`,
      `    lng:       ${g.lng},`,
      `    foto:      ${g.foto ? JSON.stringify(g.foto) : "null"},`,
      `    fotoUrl:   ${g.fotoUrl ? JSON.stringify(g.fotoUrl) : "null"},`,
      `    text:      ${JSON.stringify(g.text)},`,
      `    datum:     ${g.datum ? JSON.stringify(g.datum) : "null"},`,
      `    kategorie: ${g.kategorie ? JSON.stringify(g.kategorie) : "null"}`,
      `  }`,
    ].join("\n");
  }).join(",\n\n");

  return [
    `// data.js â€“ Schnapsglas-Sammlung`,
    `// Zuletzt aktualisiert: ${new Date().toLocaleDateString("de-DE")}`,
    `// ${GLAESER.length} GlÃ¤ser gespeichert`,
    ``,
    `const GLAESER = [`,
    eintraege,
    `];`,
  ].join("\n");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA.JS HERUNTERLADEN
   Erstellt eine echte .js-Datei und lÃ¶st den Browser-
   Download aus â€” kein Copy-Paste mehr nÃ¶tig.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function dataJsHerunterladen() {
  const inhalt = generiereDataJs();

  // Datei-Objekt im Speicher erstellen
  const blob = new Blob([inhalt], { type: "text/javascript;charset=utf-8;" });

  // TemporÃ¤ren Download-Link erzeugen und klicken
  const url = URL.createObjectURL(blob);
  const a   = document.createElement("a");
  a.href     = url;
  a.download = "data.js";
  a.click();

  // Speicher wieder freigeben
  URL.revokeObjectURL(url);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLÃ„SER-LISTE Ã–FFNEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function listeOeffnen() {
  const eintraege = GLAESER.length === 0
    ? `<div class="glaeser-liste-leer"><span>ğŸ¥ƒ</span>Noch keine GlÃ¤ser eingetragen.</div>`
    : GLAESER.map(g => `
        <div class="glas-karte" id="glas-karte-${g.id}">
          <div class="glas-karte-top">
            <div class="glas-karte-foto">
              ${g.foto
                ? `<img src="${g.foto}" alt="${esc(g.name)}">`
                : `ğŸ¥ƒ`}
            </div>
            <div class="glas-karte-info">
              <div class="glas-karte-name">${esc(g.name)}</div>
              <div class="glas-karte-land">${esc(g.land)}</div>
              ${g.kategorie === "gekauft"
                ? `<div class="glas-karte-kategorie gekauft">âœˆ Gekauft</div>`
                : g.kategorie === "geschenkt"
                ? `<div class="glas-karte-kategorie geschenkt">ğŸ Geschenkt</div>`
                : ""}
              ${g.datum ? `<div class="glas-karte-datum">ğŸ“… ${formatDatum(g.datum)}</div>` : ""}
            </div>
          </div>
          <div class="glas-karte-aktionen">
            <button class="glas-aktion-btn bearbeiten" onclick="glasBearbeitenOeffnen(${g.id})">
              âœ Bearbeiten
            </button>
            <button class="glas-aktion-btn loeschen" onclick="glasLoeschen(${g.id})">
              ğŸ—‘ LÃ¶schen
            </button>
          </div>
        </div>`).join("");

  setSheet(
    `ğŸ“‹ Meine GlÃ¤ser (${GLAESER.length})`,
    `<div class="glaeser-liste">${eintraege}</div>
     <!-- Versteckter File-Input fÃ¼r CSV-Import -->
     <input type="file" id="csv-input" accept=".csv" style="display:none"
            onchange="csvImportieren(this)">`,
    `<button class="btn-secondary" onclick="overlaySchliessen()">SchlieÃŸen</button>
     <button class="btn-secondary" style="color:var(--muted);font-size:0.72rem"
             onclick="csvVorlageHerunterladen()" title="Leere CSV-Vorlage herunterladen">
       ğŸ“„ CSV-Vorlage
     </button>
     <button class="btn-secondary" style="color:var(--gold);border-color:var(--border-gold)"
             onclick="document.getElementById('csv-input').click()">
       ğŸ“¥ CSV importieren
     </button>
     <button class="btn-primary" onclick="formularOeffnen()">ï¼‹ Neues Glas</button>`
  );
  overlayOeffnen();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLAS BEARBEITEN â€“ Formular vorausgefÃ¼llt Ã¶ffnen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function glasBearbeitenOeffnen(id) {
  const g = GLAESER.find(g => g.id === id);
  if (!g) return;
  aktuellesFoto = null;

  const body = `
    <div class="feedback-msg" id="form-feedback"></div>
    <div class="upload-progress" id="upload-progress">
      <div class="spinner"></div>
      <span>Foto wird hochgeladenâ€¦</span>
    </div>

    <div class="form-section">ğŸ“¸ Foto</div>
    <div class="form-group">
      <div class="foto-tabs">
        <button class="foto-tab ${!g.fotoUrl ? "aktiv" : ""}" onclick="fotoTabWechseln('upload', this)">ğŸ“· Kamera / Galerie</button>
        <button class="foto-tab ${g.fotoUrl  ? "aktiv" : ""}" onclick="fotoTabWechseln('url', this)">ğŸŒ Link aus Internet</button>
      </div>

      <!-- Tab 1: Datei-Upload -->
      <div class="foto-upload-bereich ${!g.fotoUrl ? "aktiv" : ""}" id="foto-upload-bereich">
        <div class="foto-upload-area ${(g.foto && !g.fotoUrl) ? "has-foto" : ""}"
             id="foto-area" onclick="document.getElementById('foto-input').click()">
          <div class="foto-placeholder" id="foto-placeholder"
               style="${(g.foto && !g.fotoUrl) ? "display:none" : ""}">
            <span class="icon">ğŸ“·</span>
            <p>Foto aufnehmen oder aus Galerie wÃ¤hlen</p>
            <span>JPG, PNG â€“ max. 10 MB</span>
          </div>
          <img class="foto-preview" id="foto-preview"
               src="${(g.foto && !g.fotoUrl) ? g.foto : ""}"
               style="${(g.foto && !g.fotoUrl) ? "" : "display:none"}">
          <span class="foto-change" id="foto-change"
                style="${(g.foto && !g.fotoUrl) ? "" : "display:none"}">Foto Ã¤ndern</span>
        </div>
        <input type="file" id="foto-input" accept="image/*" capture="environment"
               onchange="fotoGewaehlt(this)">
      </div>

      <!-- Tab 2: URL -->
      <div class="foto-url-bereich ${g.fotoUrl ? "aktiv" : ""}" id="foto-url-bereich">
        <input type="url" id="f-foto-url"
               value="${esc(g.fotoUrl || "")}"
               placeholder="https://upload.wikimedia.org/..."
               oninput="fotoUrlVorschau(this.value)">
        <div class="coord-hint" style="margin-top:5px">
          ğŸ’¡ Wikipedia: Bild Ã¶ffnen â†’ Rechtsklick â†’ "Bildadresse kopieren"
        </div>
        <img class="foto-url-vorschau ${g.fotoUrl ? "sichtbar" : ""}" id="foto-url-vorschau"
             src="${esc(g.fotoUrl || "")}" alt="Vorschau">
        <div class="foto-url-fehler" id="foto-url-fehler">âš  Bild konnte nicht geladen werden. URL prÃ¼fen.</div>
      </div>
    </div>

    <div class="form-section">ğŸ· Kategorie</div>
    <div class="form-group">
      <label>Wie hast du das Glas bekommen? <span class="req">*</span></label>
      <select id="f-kategorie">
        <option value="">â€“ bitte auswÃ¤hlen â€“</option>
        <option value="gekauft"   ${g.kategorie === "gekauft"   ? "selected" : ""}>âœˆ Selbst auf Reisen gekauft</option>
        <option value="geschenkt" ${g.kategorie === "geschenkt" ? "selected" : ""}>ğŸ Geschenkt bekommen</option>
      </select>
    </div>

    <div class="form-section">ğŸ“ Ort</div>
    <div class="form-group">
      <label>Ort &amp; Name <span class="req">*</span></label>
      <input type="text" id="f-name" value="${esc(g.name)}" placeholder="z.B. Berlin, Deutschland">
    </div>
    <div class="form-group">
      <label>Land (kurz) <span class="req">*</span></label>
      <input type="text" id="f-land" value="${esc(g.land)}" placeholder="z.B. Deutschland">
    </div>
    <div class="form-group">
      <label>Koordinaten <span class="req">*</span></label>
      <div class="coord-row">
        <input type="number" id="f-lat" value="${g.lat}" placeholder="Breitengrad" step="any">
        <input type="number" id="f-lng" value="${g.lng}" placeholder="LÃ¤ngengrad"  step="any">
      </div>
      <div class="coord-hint">
        ğŸ—º <a href="https://maps.google.com" target="_blank">Google Maps</a>
        â†’ Ort antippen â†’ Koordinaten ablesen
      </div>
    </div>
    <div class="form-group">
      <label>Datum des Kaufs</label>
      <input type="date" id="f-datum" value="${g.datum || ""}">
    </div>

    <div class="form-section">ğŸ¥ƒ Geschichte</div>
    <div class="form-group">
      <label>Deine persÃ¶nliche Geschichte <span class="req">*</span></label>
      <textarea id="f-text"
        placeholder="Wo hast du das Glas gefunden?">${esc(g.text)}</textarea>
    </div>
  `;

  const footer = `
    <button class="btn-secondary" onclick="listeOeffnen()">â† ZurÃ¼ck zur Liste</button>
    <button class="btn-primary" id="submit-btn" onclick="glasSpeichern(${id})">ğŸ’¾ Ã„nderungen speichern</button>
  `;

  setSheet(`âœ Bearbeiten`, body, footer);
  overlayOeffnen();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLAS SPEICHERN (nach Bearbeitung)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function glasSpeichern(id) {
  const idx  = GLAESER.findIndex(g => g.id === id);
  if (idx < 0) return;

  const name      = document.getElementById("f-name")?.value.trim()      || "";
  const land      = document.getElementById("f-land")?.value.trim()      || "";
  const lat       = parseFloat(document.getElementById("f-lat")?.value   || "");
  const lng       = parseFloat(document.getElementById("f-lng")?.value   || "");
  const datum     = document.getElementById("f-datum")?.value            || "";
  const text      = document.getElementById("f-text")?.value.trim()      || "";
  const kategorie = document.getElementById("f-kategorie")?.value        || "";

  if (!name || !land || !text) {
    zeigeFeedback("form-feedback", "Bitte Ort, Land und Geschichte ausfÃ¼llen.", "err"); return;
  }
  if (!kategorie) {
    zeigeFeedback("form-feedback", "Bitte eine Kategorie auswÃ¤hlen.", "err"); return;
  }
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
    zeigeFeedback("form-feedback", "UngÃ¼ltige Koordinaten. Breitengrad: âˆ’90 bis 90, LÃ¤ngengrad: âˆ’180 bis 180.", "err"); return;
  }

  const btn = document.getElementById("submit-btn");
  btn.disabled = true;

  // Foto: neues hochladen, URL nutzen, oder altes behalten
  let fotoUrl   = GLAESER[idx].foto;
  let fotoIsUrl = !!GLAESER[idx].fotoUrl;
  const fotoUrlEingabe = document.getElementById("f-foto-url")?.value.trim() || "";

  if (aktuellesFoto) {
    fotoIsUrl = false;
    if (CONFIG.cloudinary_cloud_name === "DEIN_CLOUD_NAME") {
      zeigeFeedback("form-feedback", "âš  Cloudinary nicht eingerichtet. Foto wird nicht aktualisiert.", "err");
    } else {
      document.getElementById("upload-progress").classList.add("active");
      const neueFotoUrl = await fotoHochladen(aktuellesFoto.blob);
      document.getElementById("upload-progress").classList.remove("active");
      if (neueFotoUrl) fotoUrl = neueFotoUrl;
      else zeigeFeedback("form-feedback", "Foto-Upload fehlgeschlagen. Altes Foto bleibt.", "err");
    }
  } else if (fotoUrlEingabe) {
    fotoUrl   = fotoUrlEingabe;
    fotoIsUrl = true;
  }

  // Alte Koordinaten merken, dann Daten aktualisieren
  const alterLat = GLAESER[idx].lat;
  const alterLng = GLAESER[idx].lng;
  GLAESER[idx] = { id, name, land, lat, lng, foto: fotoUrl, fotoUrl: fotoIsUrl ? fotoUrl : null, text, datum, kategorie };

  // Marker aktualisieren â€“ bei KoordinatenÃ¤nderung auch alten Ort neu rendern
  markerAktualisieren(lat, lng);
  if (alterLat !== lat || alterLng !== lng) {
    markerAktualisieren(alterLat, alterLng);
  }

  // ZÃ¤hler (Anzahl bleibt gleich, aber aktualisieren)
  const n = GLAESER.length;
  document.getElementById("zaehler").textContent = n + (n === 1 ? " Glas" : " GlÃ¤ser");

  overlaySchliessen();
  setTimeout(() => exportHinweis(name), 400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLAS LÃ–SCHEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function glasLoeschen(id) {
  const g = GLAESER.find(g => g.id === id);
  if (!g) return;
  if (!confirm(`"${g.name}" wirklich lÃ¶schen?`)) return;

  const { lat, lng } = g;

  // Aus Array entfernen
  const idx = GLAESER.findIndex(g => g.id === id);
  if (idx >= 0) GLAESER.splice(idx, 1);

  // Marker dieser Gruppe neu rendern (oder entfernen wenn leer)
  markerAktualisieren(lat, lng);
  if (markerMap[id]) delete markerMap[id];

  // ZÃ¤hler aktualisieren
  const n = GLAESER.length;
  document.getElementById("zaehler").textContent = n + (n === 1 ? " Glas" : " GlÃ¤ser");

  listeOeffnen();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV IMPORTIEREN
   Format: UTF-8, Semikolon-getrennt, erste Zeile = Kopfzeile
   Pflichtfelder: name;land;lat;lng;text
   Optional:      datum
   Duplikate (gleicher Name + Koordinaten) werden Ã¼bersprungen.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function csvImportieren(input) {
  const datei = input.files[0];
  if (!datei) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      // BOM entfernen (Excel schreibt oft einen UTF-8 BOM an den Anfang)
      const text  = e.target.result.replace(/^\uFEFF/, "");
      const zeilen = text.split(/\r?\n/).filter(z => z.trim() !== "");

      if (zeilen.length < 2) {
        csvFeedback("Die CSV-Datei ist leer oder enthÃ¤lt nur die Kopfzeile.", "err");
        return;
      }

      // â”€â”€ Kopfzeile lesen â”€â”€
      const kopf = csvZeileParsieren(zeilen[0]).map(s => s.toLowerCase().trim());

      // Spalten-Indizes bestimmen
      const idx = {
        name:      kopf.indexOf("name"),
        land:      kopf.indexOf("land"),
        lat:       kopf.indexOf("lat"),
        lng:       kopf.indexOf("lng"),
        text:      kopf.indexOf("text"),
        datum:     kopf.indexOf("datum"),
        kategorie: kopf.indexOf("kategorie"),
        fotoUrl:   kopf.indexOf("fotourl"),
      };

      // Pflichtfelder prÃ¼fen
      const fehlend = ["name","land","lat","lng","text"].filter(k => idx[k] < 0);
      if (fehlend.length > 0) {
        csvFeedback(
          `Fehlende Spalten: ${fehlend.join(", ")}. ` +
          `Die Kopfzeile muss enthalten: name;land;lat;lng;text`,
          "err"
        );
        return;
      }

      let hinzugefuegt = 0;
      let uebersprungen = 0;
      const fehler = [];

      // â”€â”€ Datenzeilen verarbeiten â”€â”€
      for (let i = 1; i < zeilen.length; i++) {
        const felder = csvZeileParsieren(zeilen[i]);

        const name      = (felder[idx.name]  || "").trim();
        const land      = (felder[idx.land]  || "").trim();
        const lat       = parseFloat((felder[idx.lat] || "").replace(",", "."));
        const lng       = parseFloat((felder[idx.lng] || "").replace(",", "."));
        const text      = (felder[idx.text]  || "").trim();
        const datum     = idx.datum     >= 0 ? (felder[idx.datum]     || "").trim() : "";
        const kategorie = idx.kategorie >= 0 ? (felder[idx.kategorie] || "").trim().toLowerCase() : "";
        const fotoUrl   = idx.fotoUrl   >= 0 ? (felder[idx.fotoUrl]   || "").trim() : "";

        // Zeile validieren
        if (!name || !land || !text) {
          fehler.push(`Zeile ${i + 1}: Name, Land oder Text fehlt.`);
          uebersprungen++;
          continue;
        }
        if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          fehler.push(`Zeile ${i + 1} (${name}): UngÃ¼ltige Koordinaten.`);
          uebersprungen++;
          continue;
        }

        // Duplikat-PrÃ¼fung: gleicher Name UND Ã¤hnliche Koordinaten
        const doppelt = GLAESER.some(g =>
          g.name === name &&
          Math.abs(g.lat - lat) < 0.001 &&
          Math.abs(g.lng - lng) < 0.001
        );
        if (doppelt) {
          uebersprungen++;
          continue;
        }

        // Datum-Format: Excel schreibt manchmal DD.MM.YYYY statt YYYY-MM-DD
        let datumFormatiert = datum;
        if (datum && datum.includes(".")) {
          const teile = datum.split(".");
          if (teile.length === 3) {
            // DD.MM.YYYY â†’ YYYY-MM-DD
            datumFormatiert = `${teile[2].padStart(4,"0")}-${teile[1].padStart(2,"0")}-${teile[0].padStart(2,"0")}`;
          }
        }

        // Glas hinzufÃ¼gen
        const glas = {
          id:    naechsteId++,
          name, land, lat, lng,
          foto:     fotoUrl || null,
          fotoUrl:  fotoUrl || null,
          text,
          datum: datumFormatiert || null,
          kategorie: ["gekauft","geschenkt"].includes(kategorie) ? kategorie : null
        };
        GLAESER.push(glas);
        hinzugefuegt++;
      }

      // Alle neuen Marker auf Karte setzen (gruppiert, mit Foto)
      const neueOrte = new Set(
        GLAESER.slice(GLAESER.length - hinzugefuegt).map(g => `${g.lat},${g.lng}`)
      );
      neueOrte.forEach(key => {
        const [lat, lng] = key.split(",").map(Number);
        markerAktualisieren(lat, lng);
      });

      // ZÃ¤hler aktualisieren
      const n = GLAESER.length;
      document.getElementById("zaehler").textContent = n + (n === 1 ? " Glas" : " GlÃ¤ser");

      // Ergebnis-Panel zeigen
      input.value = ""; // File-Input zurÃ¼cksetzen
      csvErgebnis(hinzugefuegt, uebersprungen, fehler);

    } catch(err) {
      csvFeedback("Fehler beim Lesen der Datei: " + err.message, "err");
    }
  };

  // UTF-8 lesen (wichtig fÃ¼r Umlaute!)
  reader.readAsText(datei, "UTF-8");
}

/* â”€â”€ CSV-Zeile korrekt parsen (mit AnfÃ¼hrungszeichen-UnterstÃ¼tzung) â”€â”€ */
function csvZeileParsieren(zeile) {
  const felder = [];
  let feld = "";
  let inAnfuehrung = false;

  for (let i = 0; i < zeile.length; i++) {
    const c = zeile[i];
    if (c === '"') {
      if (inAnfuehrung && zeile[i + 1] === '"') {
        // Doppeltes AnfÃ¼hrungszeichen = ein echtes
        feld += '"'; i++;
      } else {
        inAnfuehrung = !inAnfuehrung;
      }
    } else if (c === ";" && !inAnfuehrung) {
      felder.push(feld);
      feld = "";
    } else {
      feld += c;
    }
  }
  felder.push(feld);
  return felder;
}

/* â”€â”€ Ergebnis-Panel nach dem Import â”€â”€ */
function csvErgebnis(hinzugefuegt, uebersprungen, fehler) {
  const fehlerListe = fehler.length > 0
    ? `<div style="margin-top:12px;">
        <div class="form-section" style="margin-top:0">âš  Hinweise</div>
        <div style="font-size:0.75rem;color:var(--muted);line-height:1.8;">
          ${fehler.map(f => `â€¢ ${esc(f)}`).join("<br>")}
        </div>
      </div>`
    : "";

  setSheet(
    "âœ“ CSV importiert",
    `<div style="text-align:center;padding:16px 0 20px;">
      <div style="font-size:3rem;margin-bottom:12px;">ğŸ“¥</div>
      <p style="color:var(--hell);font-size:1rem;margin-bottom:6px;">
        <strong>${hinzugefuegt}</strong> Glas/GlÃ¤ser erfolgreich importiert
      </p>
      ${uebersprungen > 0
        ? `<p style="color:var(--muted);font-size:0.82rem;">${uebersprungen} Zeile(n) Ã¼bersprungen (ungÃ¼ltig oder doppelt)</p>`
        : `<p style="color:var(--green);font-size:0.82rem;">Alle Zeilen verarbeitet âœ“</p>`}
    </div>
    ${fehlerListe}
    <div style="margin-top:14px;">
      <div class="form-section" style="margin-top:0">ğŸ’¾ Jetzt speichern</div>
      <p style="color:var(--muted);font-size:0.79rem;line-height:1.6;">
        Die neuen GlÃ¤ser sind auf der Karte sichtbar. Lade die
        <code style="color:var(--gold)">data.js</code> herunter und
        lade sie auf GitHub hoch damit alles dauerhaft gespeichert wird.
      </p>
    </div>`,
    `<button class="btn-secondary" onclick="listeOeffnen()">â† ZurÃ¼ck zur Liste</button>
     <button class="btn-primary" style="background:var(--green,#4A9460)" onclick="dataJsHerunterladen()">â¬‡ data.js herunterladen</button>`
  );
  overlayOeffnen();
}

/* â”€â”€ Kurze Fehlermeldung im laufenden Panel â”€â”€ */
function csvFeedback(text, typ) {
  // Kein eigenes Feedback-Element in der Liste â€“ Alert als Fallback
  alert((typ === "err" ? "âš  " : "âœ“ ") + text);
}

/* â”€â”€ Vorlage-CSV herunterladen (Hilfsfunktion, falls nÃ¶tig) â”€â”€ */
function csvVorlageHerunterladen() {
  const inhalt =
    "name;land;lat;lng;text;datum;kategorie;fotoUrl\n" +
    "Berlin, Deutschland;Deutschland;52.52;13.405;Erstes Glas meiner Sammlung â€“ Souvenir vom Stadtbummel.;2024-06-15;gekauft;\n" +
    "Wien, Ã–sterreich;Ã–sterreich;48.2082;16.3738;SchÃ¶nes Glasl vom Naschmarkt â€“ ein Geschenk von Anna.;2024-08-20;geschenkt;https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Wien_Schoenbrunn_Schloss.jpg/320px-Wien_Schoenbrunn_Schloss.jpg\n";

  const blob = new Blob(["\uFEFF" + inhalt], { type: "text/csv;charset=utf-8;" });
  const url  = URL.createObjectURL(blob);
  const a    = Object.assign(document.createElement("a"), {
    href: url, download: "schnapsglas-vorlage.csv"
  });
  a.click();
  URL.revokeObjectURL(url);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let filterZustand = { kategorien: [], laender: [], jahre: [] };

function filterToggle() {
  const panel = document.getElementById("filter-panel");
  const offen = panel.classList.toggle("offen");
  document.getElementById("filter-btn").classList.toggle("aktiv", offen);
  if (offen) filterBefuellen();
}

function filterBefuellen() {
  // Alle LÃ¤nder sammeln (sortiert)
  const laenderSet = [...new Set(GLAESER.map(g => g.land).filter(Boolean))].sort();
  const laenderAnzahl = {};
  GLAESER.forEach(g => { if (g.land) laenderAnzahl[g.land] = (laenderAnzahl[g.land] || 0) + 1; });

  // Alle Jahre sammeln (sortiert absteigend)
  const jahreSet = [...new Set(
    GLAESER.map(g => g.datum ? g.datum.slice(0,4) : null).filter(Boolean)
  )].sort((a,b) => b - a);

  document.getElementById("filter-body").innerHTML = `
    <div class="filter-section">Kategorie</div>
    <div class="filter-chips">
      <button class="filter-chip alle ${filterZustand.kategorien.length === 0 ? "aktiv" : ""}"
              onclick="filterKategorieToggle('alle')">ğŸ¥ƒ Alle</button>
      <button class="filter-chip gekauft ${filterZustand.kategorien.includes('gekauft') ? "aktiv" : ""}"
              onclick="filterKategorieToggle('gekauft')">âœˆ Gekauft</button>
      <button class="filter-chip geschenkt ${filterZustand.kategorien.includes('geschenkt') ? "aktiv" : ""}"
              onclick="filterKategorieToggle('geschenkt')">ğŸ Geschenkt</button>
    </div>

    <div class="filter-section">Land</div>
    ${laenderSet.length === 0
      ? `<p style="color:var(--muted);font-size:0.8rem;">Keine LÃ¤nder vorhanden.</p>`
      : laenderSet.map(l => `
        <div class="filter-land-item">
          <input type="checkbox" id="fl-${esc(l)}"
                 ${filterZustand.laender.includes(l) ? "checked" : ""}
                 onchange="filterLandToggle('${esc(l)}', this.checked)">
          <label for="fl-${esc(l)}">${esc(l)}</label>
          <span class="filter-land-anzahl">${laenderAnzahl[l]}</span>
        </div>`).join("")}

    ${jahreSet.length > 0 ? `
    <div class="filter-section">Jahr</div>
    ${jahreSet.map(j => `
      <div class="filter-jahr-item">
        <input type="checkbox" id="fj-${j}"
               ${filterZustand.jahre.includes(j) ? "checked" : ""}
               onchange="filterJahrToggle('${j}', this.checked)">
        <label for="fj-${j}">${j}</label>
      </div>`).join("")}` : ""}
  `;
}

function filterKategorieToggle(wert) {
  if (wert === "alle") {
    filterZustand.kategorien = [];
  } else {
    const idx = filterZustand.kategorien.indexOf(wert);
    if (idx >= 0) filterZustand.kategorien.splice(idx, 1);
    else filterZustand.kategorien.push(wert);
  }
  filterBefuellen();
}

function filterLandToggle(land, checked) {
  if (checked) { if (!filterZustand.laender.includes(land)) filterZustand.laender.push(land); }
  else { filterZustand.laender = filterZustand.laender.filter(l => l !== land); }
}

function filterJahrToggle(jahr, checked) {
  if (checked) { if (!filterZustand.jahre.includes(jahr)) filterZustand.jahre.push(jahr); }
  else { filterZustand.jahre = filterZustand.jahre.filter(j => j !== jahr); }
}

function filterAnwenden() {
  const { kategorien, laender, jahre } = filterZustand;
  let sichtbar = 0;

  GLAESER.forEach(g => {
    const katOk  = kategorien.length === 0 || kategorien.includes(g.kategorie);
    const landOk = laender.length === 0    || laender.includes(g.land);
    const jahrOk = jahre.length === 0      || (g.datum && jahre.includes(g.datum.slice(0,4)));
    const zeigen = katOk && landOk && jahrOk;

    const m = markerMap[g.id];
    if (m) {
      if (zeigen) { m.addTo(map); sichtbar++; }
      else        { map.removeLayer(m); }
    }
  });

  // Badge aktualisieren
  const aktiveFilter = kategorien.length + laender.length + jahre.length;
  const badge = document.getElementById("filter-badge");
  badge.textContent = aktiveFilter;
  badge.classList.toggle("sichtbar", aktiveFilter > 0);
  document.getElementById("filter-btn").classList.toggle("aktiv", aktiveFilter > 0);

  // ZÃ¤hler anzeigen
  document.getElementById("zaehler").textContent =
    sichtbar + " / " + GLAESER.length + " GlÃ¤ser";

  // Panel schlieÃŸen
  document.getElementById("filter-panel").classList.remove("offen");
}

function filterZuruecksetzen() {
  filterZustand = { kategorien: [], laender: [], jahre: [] };
  filterBefuellen();

  // Alle Marker wieder einblenden
  GLAESER.forEach(g => { if (markerMap[g.id]) markerMap[g.id].addTo(map); });

  // Badge zurÃ¼cksetzen
  document.getElementById("filter-badge").classList.remove("sichtbar");
  document.getElementById("filter-btn").classList.remove("aktiv");

  const n = GLAESER.length;
  document.getElementById("zaehler").textContent = n + (n === 1 ? " Glas" : " GlÃ¤ser");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARKER AKTUALISIEREN
   Zeichnet den Marker fÃ¼r einen Ort neu (nach Add/Edit/Delete).
   Entfernt alle alten Marker dieser Gruppe und setzt einen neuen.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function markerAktualisieren(lat, lng) {
  const key    = `${lat},${lng}`;
  const gruppe = GLAESER.filter(g => `${g.lat},${g.lng}` === key);

  // Alle alten Marker dieses Ortes von der Karte nehmen
  const bereitsEntfernt = new Set();
  GLAESER.forEach(g => {
    if (markerMap[g.id] && !bereitsEntfernt.has(g.id)) {
      const gKey = `${g.lat},${g.lng}`;
      if (gKey === key) {
        map.removeLayer(markerMap[g.id]);
        bereitsEntfernt.add(g.id);
      }
    }
  });
  // Auch Marker von bereits gelÃ¶schten GlÃ¤sern aufrÃ¤umen
  Object.keys(markerMap).forEach(id => {
    if (!bereitsEntfernt.has(Number(id))) {
      // prÃ¼fen ob dieser Marker zum gleichen Ort gehÃ¶rt
      const pos = markerMap[id].getLatLng?.();
      if (pos && Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001) {
        map.removeLayer(markerMap[id]);
        delete markerMap[id];
      }
    }
  });

  if (gruppe.length === 0) return;

  const kat  = gruppe.length === 1 ? gruppe[0].kategorie : null;
  const foto = gruppe[0].foto || null;
  const m   = L.marker([lat, lng], { icon: markerIcon(kat, foto) })
    .addTo(map)
    .bindPopup(gruppenPopupHTML(gruppe, 0), { maxWidth: 300, minWidth: 300 });

  gruppe.forEach(g => { markerMap[g.id] = m; });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOTO TAB WECHSELN (Kamera â†” URL)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fotoTabWechseln(tab, btn) {
  // Alle Tabs deaktivieren
  btn.closest(".foto-tabs").querySelectorAll(".foto-tab").forEach(t => t.classList.remove("aktiv"));
  btn.classList.add("aktiv");

  const uploadBereich = document.getElementById("foto-upload-bereich");
  const urlBereich    = document.getElementById("foto-url-bereich");

  if (tab === "upload") {
    uploadBereich?.classList.add("aktiv");
    urlBereich?.classList.remove("aktiv");
  } else {
    urlBereich?.classList.add("aktiv");
    uploadBereich?.classList.remove("aktiv");
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOTO URL VORSCHAU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fotoUrlVorschau(url) {
  const vorschau = document.getElementById("foto-url-vorschau");
  const fehler   = document.getElementById("foto-url-fehler");
  if (!vorschau) return;

  if (!url) {
    vorschau.classList.remove("sichtbar");
    fehler?.classList.remove("sichtbar");
    return;
  }

  vorschau.onload  = () => { vorschau.classList.add("sichtbar"); fehler?.classList.remove("sichtbar"); };
  vorschau.onerror = () => { vorschau.classList.remove("sichtbar"); fehler?.classList.add("sichtbar"); };
  vorschau.src = url;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HILFSFUNKTIONEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(str) {
  return String(str ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function zeigeFeedback(id, text, typ) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = text;
  el.className = "feedback-msg " + typ;
  setTimeout(() => { el.textContent = ""; el.className = "feedback-msg"; }, 5000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
alleGlaeserLaden();
</script>
</body>
</html>
